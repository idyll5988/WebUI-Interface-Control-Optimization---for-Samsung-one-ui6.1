<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>读取日志文件</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <style>
        body {
            margin: 20px;
            font-family: Arial, sans-serif;
            background-color: #fff;
            color: #000;
        }

        h1 {
            color: #007BFF;
            font-size: 32px;
            margin-bottom: 10px;
        }

        pre {
            background-color: #f4f4f4;
            border-radius: 5px;
            padding: 10px;
            overflow-x: auto;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        .log-content {
            max-height: 400px;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin-top: 5px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #888 transparent;
            position: relative;
            cursor: move;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        button:hover {
            background-color: #0056b3;
            color: #fff;
        }

        button:active {
            background-color: #003f80;
            color: #fff;
        }

        .modal-content {
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            background-color: #d9edf7;
            color: #31708f;
            border-bottom: 1px solid #ced4da;
        }

        .modal button {
            border-radius: 5px;
            font-size: 14px;
        }

        /* SurfaceFlinger优化开关的模态框样式 */
        #graphicOptimizationModal .modal-content {
            background-color: #f5f5f5;
            border: 2px solid #888;
            border-radius: 10px;
        }

        #graphicOptimizationModal .modal-header {
            background-color: #d9edf7;
            color: #31708f;
        }

        #graphicOptimizationModal .modal-body {
            font-size: 14px;
        }

        /* 日志内容字体美化 */
        .log-content code {
            font-family: 'Consolas', monospace;
            font-size: 14px;
            color: #000;
            background-color: #f8f8f8;
            border-radius: 5px;
            padding: 10px;
            text-shadow: 1px 1px 1px #aaa;
        }

        /* 错误信息用红色显示 */
        .log-content code span.error {
            color: #ff0000;
        }

        /* 黑暗模式样式跟随系统 */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #333;
                color: #fff;
            }

            h1 {
                color: #fff;
            }

            pre {
                background-color: #444;
                color: #fff;
            }

            .log-content {
                background-color: #444;
                border-color: #555;
            }

            .log-content code {
                background-color: #555;
                color: #fff;
            }

            .log-content code span.error {
                color: #ff0000;
            }

            .button-group button {
                background-color: #555;
                border-color: #555;
            }

            .button-group button:hover {
                background-color: #777;
                color: #fff;
            }

            .button-group button:active {
                background-color: #999;
                color: #fff;
            }

            .modal-content {
                background-color: #444;
                border-color: #555;
                color: #fff;
            }

            .modal-header {
                background-color: #555;
                color: #fff;
            }

            .modal button {
                background-color: #555;
                border-color: #555;
                color: #000;
            }

            #confirmClearModal .modal-body,
            #graphicOptimizationModal .modal-body,
            #apatchReadableModal .modal-body,
            #lowHeatModeModal .modal-body,
            #intelligentSleepModeModal .modal-body {
                color: #000;
            }
        }
    </style>
</head>

<body>
    <div>
        <h1 class="text-blue">idyll_负优化调节™® 面板</h1>
        <div class="log-content" id="logContentContainer">
            <pre><code id="logContent">正在加载...</code></pre>
        </div>

        <div class="button-group">
            <button id="refreshLogBtn" class="btn btn-primary">刷新日志</button>
            <button id="clearLogBtn" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmClearModal">清空日志</button>
            <button id="touchWifiBtn" class="btn btn-info">隐藏功能</button>
        </div>

        <form id="systemOptimizationForm">
            <div class="form-check form-switch">
                <label for="graphicOptimizationSwitch">SurfaceFlinger优化</label>
                <input class="form-check-input" type="checkbox" role="switch" id="graphicOptimizationSwitch">
            </div>

            <div class="form-check form-switch">
                <label for="intelligentSleepModeSwitch">智能休眠模式</label>
                <input class="form-check-input" type="checkbox" role="switch" id="intelligentSleepModeSwitch">
            </div>

            <div class="form-check form-switch">
                <label for="lowHeatModeSwitch">低热量模式</label>
                <input class="form-check-input" type="checkbox" role="switch" id="lowHeatModeSwitch">
            </div>

            <div class="form-check form-switch">
                <label for="apatchReadableSwitch">APatch-KSU分区读写</label>
                <input class="form-check-input" type="checkbox" role="switch" id="apatchReadableSwitch">
            </div>

            <div class="form-group">
                <label for="greenDotOption">禁用与恢复绿点切换：</label>
                <select id="greenDotOption">
                    <option value="禁用">禁用</option>
                    <option value="恢复">恢复</option>
                </select>
            </div>
        </form>

        <div class="modal fade" id="confirmClearModal" tabindex="-1" aria-labelledby="confirmClearModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmClearModalLabel">确认清空日志</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">您确定要清空日志文件吗？此操作无法撤销！</div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-danger" id="confirmClearBtn">确认清空</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="graphicOptimizationModal" tabindex="-1" aria-labelledby="graphicOptimizationModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="graphicOptimizationModalLabel">SurfaceFlinger设置</h5>
                    </div>
                    <div class="modal-body">
                        <p>SurfaceFlinger配置优化</p>
                        <ul>
                            <li>开启: 启用VSync并缩短超时时间（提升同步精度）优化图层合成策略（减少延迟）</li>
                        </ul>
                        您确定要开启吗？
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmGraphicOptimizationBtn">确认</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="intelligentSleepModeModal" tabindex="-1" aria-labelledby="intelligentSleepModeModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="intelligentSleepModeModalLabel">智能休眠模式设置</h5>
                    </div>
                    <div class="modal-body">
                        <p>核心功能: 该模式控制后台进程的存活率和待机续航之间的平衡</p>
                        <ul>
                            <li>开启: 后台进程存活率所有应用提升至60-70%，待机续航（24小时）可能损耗12-18%电量</li>
                            <li>关闭: 后台进程存活率普通应用<30%，系统应用>80%，待机续航（24小时）约损耗5-8%电量</li>
                        </ul>
                        您确定要开启吗？
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmIntelligentSleepModeBtn">确认</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="apatchReadableModal" tabindex="-1" aria-labelledby="apatchReadableModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="apatchReadableModalLabel">APatch-KernelSU分区可读写设置</h5>
                    </div>
                    <div class="modal-body">
                        此功能只支持APatch与KSU通过OverlayFS实现分区可读写。您确定要开启吗？建议重启！
                        <br>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="restartCheckbox">
                            <label class="form-check-label" for="restartCheckbox">重启设备</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmApatchReadableBtn">确认</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="lowHeatModeModal" tabindex="-1" aria-labelledby="lowHeatModeModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="lowHeatModeModalLabel">低热量模式设置</h5>
                    </div>
                    <div class="modal-body">
                        核心功能: 该模式通过主动限制性能、降低功耗来减少设备发热，类似于"温控降频"机制
                        <ul>
                            <li>开启:性能释放：CPU/GPU可满血运行，充电功率不受软件限制（仍需硬件支持）</li>
                            <li>关闭:CPU/GPU负载降低，热量产生减少，功耗下降可能提升电池续航</li>
                        </ul>
                        您确定要开启吗？
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmLowHeatModeBtn">确认</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="touchWifiModal" tabindex="-1" aria-labelledby="touchWifiModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="touchWifiModalLabel">隐藏功能</h5>
                    </div>
                    <div class="modal-body">
					    核心功能: 只需简单几步，不仅能提升WiFi网速，还能解决可能出现的触屏问题
                        <ul>
						    <li>在固件菜单中先点击"TSP FW update"等待更新成功，然后"WACOM FW Update"可为触控屏调节最佳响应速度 </li>
                            <li>在固件菜单点击"刷新"Refresh WiFi"版本"按钮随后您的手机将重新启动，WiFi速度应该会显著提升</li>
                        </ul>
                        您确定要开启吗？
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmTouchWifiBtn">确认打开</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        let callbackSequenceNumber = 0;
        let logEntries = [];
        let currentPage = 1;
        const logsPerPage = 10;

        function execCommand(command, args = {}) {
            return new Promise((resolve, reject) => {
                let callbackName = `exec_callback_${Date.now()}_${callbackSequenceNumber++}`;
                window[callbackName] = (errno, stdout, stderr) => {
                    if (errno === 0) {
                        resolve({ errno, stdout, stderr });
                    } else {
                        const errorMessage = `执行 ${command} 时出错：错误号 ${errno}，标准错误信息：${stderr}`;
                        console.error(errorMessage);
                        reject({ errno, stdout, stderr });
                    }
                    delete window[callbackName];
                };
                ksu.exec(command, JSON.stringify(args), callbackName);
            });
        }

        async function readLogFile() {
            try {
                let { errno, stdout, stderr } = await execCommand("cat /data/adb/modules/WebUI/scripts/ll/log/配置.log");
                if (errno === 0) {
                    return stdout || "日志文件为空。";
                } else {
                    throw new Error(`读取日志文件时出错：错误号 ${errno}，标准错误信息：${stderr}`);
                }
            } catch (error) {
                throw error;
            }
        }

        async function processLogDisplay() {
            const logText = await readLogFile();
            if (logText) {
                let processedLog = logText.replace(/ERROR/g, '<span class="error">ERROR</span>');
                document.getElementById("logContent").innerHTML = processedLog;
            } else {
                document.getElementById("logContent").textContent = '读取日志文件时出错。';
            }
            hljs.highlightElement(document.getElementById("logContent"));
        }

        async function clearLog() {
            try {
                let { errno, stdout, stderr } = await execCommand('rm -f /data/adb/modules/WebUI/scripts/ll/log/配置.log');
                if (errno === 0) {
                    document.getElementById("logContent").textContent = "日志文件清空成功。";
                    await processLogDisplay();
                } else {
                    throw new Error(`清空日志文件时出错：错误号 ${errno}，标准错误信息：${stderr}`);
                }
            } catch (error) {
                throw error;
            }
        }

        async function enableGraphicOptimization() {
            try {
                let commands = [
                    "cmd device_config put surfaceflinger surfaceflinger.vsync.enable true",
                    "cmd device_config put surfaceflinger surfaceflinger.vsync.timeout 5",
                    "cmd device_config put surfaceflinger surfaceflinger.use_content_detection_for_refresh_rate true"
                ];
                for (let command of commands) {
                    let { errno, stdout, stderr } = await execCommand(command);
                    if (errno !== 0) {
                        throw new Error(`执行命令时出错：错误号 ${errno}，标准错误信息：${stderr}`);
                    }
                }
            } catch (error) {
                throw error;
            }
        }

        async function disableGraphicOptimization() {
            try {
                let commands = [
                    "cmd device_config put surfaceflinger surfaceflinger.vsync.enable reset",
                    "cmd device_config put surfaceflinger surfaceflinger.vsync.timeout reset",
                    "cmd device_config put surfaceflinger surfaceflinger.use_content_detection_for_refresh_rate true"
                ];
                for (let command of commands) {
                    let { errno, stdout, stderr } = await execCommand(command);
                    if (errno !== 0) {
                        throw new Error(`执行命令时出错：错误号 ${errno}，标准错误信息：${stderr}`);
                    }
                }
            } catch (error) {
                throw error;
            }
        }

        async function enableApatchReadable() {
            try {
                let commands = [
                    "mkdir -p /data/adb/modules/.rw/{system,vendor,system_ext,product}/{upperdir,workdir}"
                ];
                for (let command of commands) {
                    let { errno, stdout, stderr } = await execCommand(command);
                    if (errno !== 0) {
                        throw new Error(`执行命令时出错：错误号 ${errno}，标准错误信息：${stderr}`);
                    }
                }
            } catch (error) {
                throw error;
            }
        }

        async function disableApatchReadable() {
            try {
                let command = 'rm -rf /data/adb/modules/.rw';
                let { errno, stdout, stderr } = await execCommand(command);
                if (errno !== 0) {
                    throw new Error(`执行命令时出错：错误号 ${errno}，标准错误信息：${stderr}`);
                }
            } catch (error) {
                throw error;
            }
        }

        async function enableLowHeatMode() {
            try {
                let command = "cmd settings put global sem_low_heat_mode 0";  
                let { errno, stdout, stderr } = await execCommand(command);
                if (errno !== 0) {
                    throw new Error(`执行命令时出错：错误号 ${errno}，标准错误信息：${stderr}`);
                }
                await updateLowHeatModeUI();
            } catch (error) {
                throw error;
            }
        }

        async function disableLowHeatMode() {
            try {
                let command = "cmd settings put global sem_low_heat_mode 1";  
                let { errno, stdout, stderr } = await execCommand(command);
                if (errno !== 0) {
                    throw new Error(`执行命令时出错：错误号 ${errno}，标准错误信息：${stderr}`);
                }
                await updateLowHeatModeUI();
            } catch (error) {
                throw error;
            }
        }

        async function checkLowHeatModeState() {
            try {
                let { errno, stdout, stderr } = await execCommand("cmd settings get global sem_low_heat_mode");
                if (errno === 0 && stdout.trim() === "0") {
                    return true;
                } else {
                    return false;
                }
            } catch (error) {
                console.error("检查低热量模式状态时出错:", error);
                return false;
            }
        }

        async function updateLowHeatModeUI() {
            const isEnabled = await checkLowHeatModeState();
            lowHeatModeSwitch.checked = isEnabled;
        }

        async function enableIntelligentSleepMode() {
            try {
                let command = "cmd settings put system intelligent_sleep_mode 0"; 
                let { errno, stdout, stderr } = await execCommand(command);
                if (errno !== 0) {
                    throw new Error(`执行命令时出错：错误号 ${errno}，标准错误信息：${stderr}`);
                }
                await updateIntelligentSleepModeUI();
            } catch (error) {
                throw error;
            }
        }

        async function disableIntelligentSleepMode() {
            try {
                let command = "cmd settings put system intelligent_sleep_mode 1"; 
                let { errno, stdout, stderr } = await execCommand(command);
                if (errno !== 0) {
                    throw new Error(`执行命令时出错：错误号 ${errno}，标准错误信息：${stderr}`);
                }
                await updateIntelligentSleepModeUI();
            } catch (error) {
                throw error;
            }
        }

        async function checkIntelligentSleepModeState() {
            try {
                let { errno, stdout, stderr } = await execCommand("cmd settings get system intelligent_sleep_mode");
                if (errno === 0 && stdout.trim() === "0") {
                    return true;
                } else {
                    return false;
                }
            } catch (error) {
                console.error("检查智能休眠模式状态时出错:", error);
                return false;
            }
        }

        async function updateIntelligentSleepModeUI() {
            const isEnabled = await checkIntelligentSleepModeState();
            intelligentSleepModeSwitch.checked = isEnabled;
        }

        async function openTouchWifi() {
            try {
                let command = "am start -n com.sec.android.app.factorykeystring/com.sec.android.tspkeystring.keystring.touch_firmware";
                let { errno, stdout, stderr } = await execCommand(command);
                if (errno !== 0) {
                    throw new Error(`打开隐藏功能功能时出错：错误号 ${errno}，标准错误信息：${stderr}`);
                }
                console.log("成功启动隐藏功能");
            } catch (error) {
                console.error("打开隐藏功能功能时出错:", error);
                throw error;
            }
        }

        async function checkMagiskDb() {
            try {
                let { errno } = await execCommand('magisk -v');
                return errno === 0;
            } catch (error) {
                console.error("检查 magisk 时出错:", error);
                return false;
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const logContent = document.getElementById("logContent");
            const refreshLogBtn = document.getElementById("refreshLogBtn");
            const clearLogBtn = document.getElementById("clearLogBtn");
            const confirmClearModal = new bootstrap.Modal(document.getElementById("confirmClearModal"), { keyboard: false });
            const confirmClearBtn = document.getElementById("confirmClearBtn");
            const graphicOptimizationSwitch = document.getElementById("graphicOptimizationSwitch");
            const greenDotOption = document.getElementById("greenDotOption");
            const apatchReadableSwitch = document.getElementById("apatchReadableSwitch");
            const lowHeatModeSwitch = document.getElementById("lowHeatModeSwitch");
            const intelligentSleepModeSwitch = document.getElementById("intelligentSleepModeSwitch");
            const touchWifiBtn = document.getElementById("touchWifiBtn");
            const touchWifiModal = new bootstrap.Modal(document.getElementById("touchWifiModal"), { keyboard: false });
            const confirmTouchWifiBtn = document.getElementById("confirmTouchWifiBtn");

            const magiskDbExists = await checkMagiskDb();
            if (magiskDbExists) {
                apatchReadableSwitch.disabled = true;
            } else {
                apatchReadableSwitch.disabled = false;
            }

            let isDragging = false;
            let offset = { x: 0, y: 0 };
            const logContentContainer = document.getElementById("logContentContainer");

            logContentContainer.addEventListener('mousedown', (e) => {
                isDragging = true;
                offset.x = e.clientX - logContentContainer.getBoundingClientRect().left;
                offset.y = e.clientY - logContentContainer.getBoundingClientRect().top;
                logContentContainer.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    logContentContainer.style.position = 'absolute';
                    logContentContainer.style.left = `${e.clientX - offset.x}px`;
                    logContentContainer.style.top = `${e.clientY - offset.y}px`;
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                logContentContainer.style.cursor = 'move';
            });

            refreshLogBtn.addEventListener("click", processLogDisplay);
            clearLogBtn.addEventListener("click", () => {
                confirmClearModal.show();
                confirmClearBtn.addEventListener("click", clearLog);
            });

            graphicOptimizationSwitch.addEventListener("change", async () => {
                const initialState = graphicOptimizationSwitch.checked;
                
                if (graphicOptimizationSwitch.checked) {
                    const graphicOptimizationModal = new bootstrap.Modal(document.getElementById('graphicOptimizationModal'), { keyboard: false });
                    graphicOptimizationModal.show();
                    
                    const confirmBtn = document.getElementById('confirmGraphicOptimizationBtn');
                    const cancelBtn = document.querySelector('#graphicOptimizationModal .btn-secondary');
                    
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                    
                    function confirmHandler() {
                        try {
                            enableGraphicOptimization();
                            graphicOptimizationModal.hide();
                        } catch (error) {
                            const errorMessage = "开启SurfaceFlinger优化时出错：详细信息如下：错误消息：" + error.message;
                            console.error(errorMessage);
                        }
                    }
                    
                    function cancelHandler() {
                        graphicOptimizationSwitch.checked = initialState;
                        graphicOptimizationModal.hide();
                    }
                    
                    confirmBtn.addEventListener('click', confirmHandler);
                    cancelBtn.addEventListener('click', cancelHandler);

                    graphicOptimizationModal._element.addEventListener('hidden.bs.modal', () => {
                        if (graphicOptimizationSwitch.checked !== initialState) {
                            graphicOptimizationSwitch.checked = initialState;
                        }
                    });
                } else {
                    try {
                        await disableGraphicOptimization();
                    } catch (error) {
                        const errorMessage = "关闭SurfaceFlinger优化时出错：详细信息如下：错误消息：" + error.message;
                        console.error(errorMessage);
                    }
                }
            });

            apatchReadableSwitch.addEventListener("change", async () => {
                const initialState = apatchReadableSwitch.checked;
                
                if (apatchReadableSwitch.checked) {
                    const apatchReadableModal = new bootstrap.Modal(document.getElementById('apatchReadableModal'), { keyboard: false });
                    apatchReadableModal.show();
                    
                    const confirmBtn = document.getElementById('confirmApatchReadableBtn');
                    const cancelBtn = document.querySelector('#apatchReadableModal .btn-secondary');

                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                    
                    function confirmHandler() {
                        try {
                            enableApatchReadable();
                            const restartCheckbox = document.getElementById('restartCheckbox');
                            if (restartCheckbox.checked) {
                                execCommand('reboot');
                            }
                            apatchReadableModal.hide();
                        } catch (error) {
                            const errorMessage = "开启 APatch-KSU 可读写时出错：详细信息如下：错误消息：" + error.message;
                            console.error(errorMessage);
                        }
                    }
                    
                    function cancelHandler() {
                        apatchReadableSwitch.checked = initialState;
                        apatchReadableModal.hide();
                    }
                    
                    confirmBtn.addEventListener('click', confirmHandler);
                    cancelBtn.addEventListener('click', cancelHandler);
                    
                    apatchReadableModal._element.addEventListener('hidden.bs.modal', () => {
                        if (apatchReadableSwitch.checked !== initialState) {
                            apatchReadableSwitch.checked = initialState;
                        }
                    });
                } else {
                    try {
                        await disableApatchReadable();
                    } catch (error) {
                        const errorMessage = "关闭 APatch-KSU 可读时出错：详细信息如下：错误消息：" + error.message;
                        console.error(errorMessage);
                    }
                }
            });

            lowHeatModeSwitch.addEventListener("change", async () => {
                const initialState = lowHeatModeSwitch.checked;
                
                if (lowHeatModeSwitch.checked) {
                    const lowHeatModeModal = new bootstrap.Modal(document.getElementById('lowHeatModeModal'), { keyboard: false });
                    lowHeatModeModal.show();
                    
                    const confirmBtn = document.getElementById('confirmLowHeatModeBtn');
                    const cancelBtn = document.querySelector('#lowHeatModeModal .btn-secondary');
                    
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                    
                    function confirmHandler() {
                        try {
                            enableLowHeatMode();
                            lowHeatModeModal.hide();
                        } catch (error) {
                            const errorMessage = "开启低热量模式时出错：详细信息如下：错误消息：" + error.message;
                            console.error(errorMessage);
                        }
                    }
                    
                    function cancelHandler() {
                        lowHeatModeSwitch.checked = initialState;
                        lowHeatModeModal.hide();
                    }
                    
                    confirmBtn.addEventListener('click', confirmHandler);
                    cancelBtn.addEventListener('click', cancelHandler);
                    
                    lowHeatModeModal._element.addEventListener('hidden.bs.modal', () => {
                        if (lowHeatModeSwitch.checked !== initialState) {
                            lowHeatModeSwitch.checked = initialState;
                        }
                    });
                } else {
                    try {
                        await disableLowHeatMode();
                    } catch (error) {
                        const errorMessage = "关闭低热量模式时出错：详细信息如下：错误消息：" + error.message;
                        console.error(errorMessage);
                    }
                }
            });

            intelligentSleepModeSwitch.addEventListener("change", async () => {
                const initialState = intelligentSleepModeSwitch.checked;
                
                if (intelligentSleepModeSwitch.checked) {
                    const intelligentSleepModeModal = new bootstrap.Modal(document.getElementById('intelligentSleepModeModal'), { keyboard: false });
                    intelligentSleepModeModal.show();
                    
                    const confirmBtn = document.getElementById('confirmIntelligentSleepModeBtn');
                    const cancelBtn = document.querySelector('#intelligentSleepModeModal .btn-secondary');

                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                    
                    function confirmHandler() {
                        try {
                            enableIntelligentSleepMode();
                            intelligentSleepModeModal.hide();
                        } catch (error) {
                            const errorMessage = "开启智能休眠模式时出错：详细信息如下：错误消息：" + error.message;
                            console.error(errorMessage);
                        }
                    }
                    
                    function cancelHandler() {
                        intelligentSleepModeSwitch.checked = initialState;
                        intelligentSleepModeModal.hide();
                    }
                    
                    confirmBtn.addEventListener('click', confirmHandler);
                    cancelBtn.addEventListener('click', cancelHandler);
                    
                    intelligentSleepModeModal._element.addEventListener('hidden.bs.modal', () => {
                        if (intelligentSleepModeSwitch.checked !== initialState) {
                            intelligentSleepModeSwitch.checked = initialState;
                        }
                    });
                } else {
                    try {
                        await disableIntelligentSleepMode();
                    } catch (error) {
                        const errorMessage = "关闭智能休眠模式时出错：详细信息如下：错误消息：" + error.message;
                        console.error(errorMessage);
                    }
                }
            });

            touchWifiBtn.addEventListener("click", () => {
                touchWifiModal.show();
            });

            confirmTouchWifiBtn.addEventListener("click", async () => {
                try {
                    await openTouchWifi();
                    touchWifiModal.hide();
                    alert("已成功隐藏功能");
                } catch (error) {
                    alert("启动隐藏功能失败：" + error.message);
                }
            });

            async function checkGraphicOptimizationState() {
                try {
                    let { errno, stdout, stderr } = await execCommand("cmd device_config get surfaceflinger surfaceflinger.vsync.enable");
                    if (errno === 0 && stdout.trim() === "true") {
                        return true;
                    } else {
                        return false;
                    }
                } catch (error) {
                    console.error("检查SurfaceFlinger优化状态时出错:", error);
                    return false;
                }
            }

            async function checkGreenDotState() {
                try {
                    let { errno, stdout } = await execCommand("cmd device_config get privacy location_indicators_enabled");
                    return errno === 0 && stdout.trim() === "false" ? "禁用" : "恢复";
                } catch (error) {
                    console.error("检查禁用恢复绿点状态时出错:", error);
                    return "未知状态";
                }
            }

            async function checkApatchReadableState() {
                try {
                    let { errno, stdout } = await execCommand("ls /data/adb/modules/.rw");
                    return errno === 0;
                } catch (error) {
                    console.error("检查 APatch-KSU 可读写状态时出错:", error);
                    return false;
                }
            }

            async function checkPreviousStates() {
                graphicOptimizationSwitch.checked = await checkGraphicOptimizationState();
                greenDotOption.value = await checkGreenDotState();
                apatchReadableSwitch.checked = await checkApatchReadableState();
                await updateLowHeatModeUI();
                await updateIntelligentSleepModeUI();
            }

            greenDotOption.addEventListener("change", async () => {
                if (greenDotOption.value === "禁用") {
                    try {
                        const commands = [
                            "cmd device_config put privacy location_indicators_enabled false default",
                            "cmd device_config put privacy camera_mic_icons_enabled false default"
                        ];
                        for (const command of commands) {
                            let { errno } = await execCommand(command);
                            if (errno !== 0) throw new Error(`执行命令时出错`);
                        }
                    } catch (error) {
                        console.error("禁用绿点时出错:", error);
                    }
                } else {
                    try {
                        const commands = [
                            "cmd device_config put privacy location_indicators_enabled true default",
                            "cmd device_config put privacy camera_mic_icons_enabled true default"
                        ];
                        for (const command of commands) {
                            let { errno } = await execCommand(command);
                            if (errno !== 0) throw new Error(`执行命令时出错`);
                        }
                    } catch (error) {
                        console.error("恢复绿点时出错:", error);
                    }
                }
            });

            let logRefreshInterval;
            function startAutoRefresh() {
                logRefreshInterval = setInterval(processLogDisplay, 5000);
            }

            function stopAutoRefresh() {
                clearInterval(logRefreshInterval);
            }

            startAutoRefresh();
            window.addEventListener('beforeunload', stopAutoRefresh);

            await checkPreviousStates();
            await processLogDisplay();

            function debounce(func, delay) {
                let timer;
                return function() {
                    const context = this;
                    const args = arguments;
                    clearTimeout(timer);
                    timer = setTimeout(() => func.apply(context, args), delay);
                };
            }

            const debouncedAdaptResolution = debounce(adaptResolution, 200);

            window.addEventListener('resize', debouncedAdaptResolution);

            function adaptResolution() {
                const container = document.querySelector('.container');
                if (container) {
                    const windowWidth = window.innerWidth;
                    const windowHeight = window.innerHeight;
                    container.style.width = windowWidth + 'px';
                    container.style.height = windowHeight + 'px';
                    const baseFontSize = 16;
                    const scaleFactor = Math.min(windowWidth / 1920, windowHeight / 1080);
                    document.documentElement.style.fontSize = baseFontSize * scaleFactor + 'px';
                }
            }

            adaptResolution();

            function checkAndApplyDarkMode() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-mode');
                    document.querySelector('h1.text-blue').style.color = '#007BFF';
                    document.querySelectorAll('body.dark-mode *').forEach(element => {
                        if (element.tagName !== 'H1') {
                            element.style.color = '#000';
                        }
                    });
                } else {
                    document.body.classList.remove('dark-mode');
                }
            }

            checkAndApplyDarkMode();
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', checkAndApplyDarkMode);
        });
    </script>
</body>

</html>    